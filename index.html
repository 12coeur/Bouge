<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes" />
  <title>BOUGE avec 12Coeur</title>
  
  <!-- Cesium 1.135 (UNE SEULE FOIS) -->
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.135/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.135/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
  
  <!-- Tes scripts -->
  <script src="TraceConverter.js"></script>
  <script src="dashboard.js"></script>
  
  <!-- Style -->
  <link href="style.css" rel="stylesheet">
</head>


<body>
  <!-- Conteneur principal Cesium -->
  <div id="cesiumContainer"></div>
  
  <!-- Dashboard flottant COMPLET (fond gris alpha 0.8) -->
  <div id="dashboard" style="display: none; position: fixed; top: 150px; left: 50%; transform: translateX(-50%); 
       background: rgba(128, 128, 128, 0.8); border: 2px solid #666; border-radius: 12px; padding: 15px; color: white; 
       z-index: 1000; min-width: 320px; max-width: 420px; box-shadow: 0 8px 32px rgba(0,0,0,0.6); 
       font-family: Arial, sans-serif; cursor: default;">
    <div id="dashboardHeader" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; 
         cursor: grab; padding-bottom: 8px; border-bottom: 1px solid #444;">
      <h3 style="margin: 0; color: #00bcd4; user-select: none;">üìä Tableau de bord</h3>
      <div>
        <button id="minimizeDashboard" style="background: none; border: none; color: #aaa; font-size: 18px; cursor: pointer; margin-right: 8px;">‚Äì</button>
        <button id="closeDashboard" style="background: #f44336; color: white; border: none; border-radius: 4px; width: 24px; height: 24px; cursor: pointer; font-weight: bold;">‚úï</button>
      </div>
    </div>
    <div class="dashboard-content">
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 14px;">
        <div>
          <strong>Vitesse</strong><br>
          <span id="speedValue" style="font-size: 22px; color: #4caf50;">0</span> km/h
        </div>
        <div>
          <strong>Altitude</strong><br>
          <span id="altitudeValue" style="font-size: 22px; color: #2196f3;">0</span> m
        </div>
        <div>
          <strong>Distance</strong><br>
          <span id="distanceValue" style="font-size: 22px; color: #ff9800;">0</span> km
        </div>
        <div>
          <strong>Temps</strong><br>
          <span id="elapsedTimeValue" style="font-size: 22px; color: #e91e63;">00:00:00</span>
        </div>
      </div>
    </div>
  </div>

  <!-- MENU MOBILE -->
  <div id="mobileMenu" class="control-panel">
    <h3>Mobile</h3>
    <div class="control-group">
      <label for="modelSelect">Mod√®le 3D :</label>
      <select id="modelSelect" style="width: 100%; padding: 6px; border-radius: 4px; border: 1px solid #666; background: #333; color: white; font-size: 12px;">
        <option value="">-- S√©lectionner un mod√®le --</option>
      </select>
      <div id="modelName" class="model-name"></div>
      
      <div class="controls-row" style="margin-top: 8px;">
        <div class="rotate-btn-container">
          <button id="rotateBtn">Tourner</button>
        </div>
        <div class="slider-container">
          <label>
            <span>√âchelle :</span>
            <span id="scaleValue">5</span>
          </label>
          <input type="range" id="scaleSlider" min="1" max="100" value="5" step="1" />
        </div>
      </div>  

      <div class="slider-container" style="margin-top: 10px;">
        <label>
          <span>√âclairage :</span>
          <span id="lightValue">1.0</span>
        </label>
        <input type="range" id="lightSlider" min="0" max="2" value="1" step="0.1" />
      </div>
      
      <div class="control-group checkbox-group">
        <input type="checkbox" id="orientCheckbox" checked />
        <label for="orientCheckbox" style="margin: 0;">Orienter selon la trajectoire</label>
      </div>
      
      <div style="margin-top: 8px;">
        <input type="file" id="glbFileInput" accept=".glb" style="display: none;" />
        <button id="loadCustomModelBtn" class="tooltip-btn" 
                style="width: 100%; padding: 6px; border-radius: 4px; border: 1px solid #666; background: #444; color: white; font-size: 12px; cursor: pointer; position: relative;"
                title="Chargez un fichier GLB personnalis√© (.glb uniquement). Le mod√®le sera ajout√© au s√©lecteur et appliqu√© √† votre trace."
                aria-label="Charger un mod√®le GLB custom">
          Charger mon mod√®le (GLB)
          <div class="tooltip-content" id="customModelTooltip">
            Chargez un fichier GLB personnalis√© (.glb uniquement).<br>
            Le mod√®le sera ajout√© au s√©lecteur et appliqu√© √† votre trace.<br>
            <small>Format support√© : GLB (binaire glTF)</small>
          </div>
        </button>
      </div>
    </div>
  </div>

  <!-- MENU TRACE -->
  <div id="traceMenu" class="control-panel">
    <h3>Trace</h3>
    
    <div id="loadingSpinner" style="display:none; padding: 6px 10px; background: #333; border-radius: 4px; border: 1px solid #666; font-size: 12px; color: #ffecb3; margin-bottom: 10px;">
      ‚è≥ Chargement du mobile...
    </div>
    
    <!-- Import fichier trace -->
    <div class="control-group">
      <label for="fileInput">Fichier trace (IGC, KML, GPX, TCX) :</label>
      <input type="file" id="fileInput" accept=".igc,.kml,.gpx,.tcx" />
    </div>

    <!-- D√©calage altitude -->
    <div class="controls-row" style="margin-top: 12px;">
      <div class="slider-container">
        <label>
          <span>D√©calage altitude (m) :</span>
          <span id="offsetValue">0</span>
        </label>
        <input type="range" id="offsetSlider" min="-500" max="500" value="0" step="0.1" />
      </div>
    </div>
    
    <!-- Case √† cocher Dashboard -->
    <div class="control-group checkbox-group" style="margin-top: 12px;">
      <input type="checkbox" id="dashboardCheckbox" />
      <label for="dashboardCheckbox" style="margin: 0;">üìä Afficher le dashboard</label>
    </div>
    
    <!-- Options d'affichage trace -->
    <div class="control-group checkbox-group" style="margin-top: 12px;">
      <input type="checkbox" id="traceCheckbox" checked />
      <label for="traceCheckbox" style="margin: 0;">Afficher la trace</label>
    </div>

    <div class="control-group checkbox-group" style="margin-top: 12px;">
      <input type="checkbox" id="colorByAltitudeCheckbox" />
      <label for="colorByAltitudeCheckbox" style="margin: 0;">Colorer par altitude (relatif √† la trace)</label>
    </div>

    <div class="control-group checkbox-group" style="margin-top: 12px;">
      <input type="checkbox" id="colorBySpeedCheckbox" />
      <label for="colorBySpeedCheckbox" style="margin: 0;">Colorer par vitesse (km/h, relatif √† la trace)</label>
    </div>
  </div>

  <!-- MENU ACTIONS -->
  <div id="resetMenu" class="control-panel">
    <h3>Actions</h3> 
    <div class="control-group">
      <button id="resetBtn" class="danger" disabled>R√©initialiser la vue</button>
    </div>
  </div>

  <!-- MENU ENVIRONNEMENT -->
  <div id="environmentMenu" class="control-panel">
    <h3>Environnement</h3>
    
    <div class="control-group checkbox-group" style="margin-top: 12px;">
      <input type="checkbox" id="skyAtmosphereCheckbox" checked />
      <label for="skyAtmosphereCheckbox" style="margin: 0;">Atmosph√®re et ciel</label>
    </div>
    
    <div class="control-group checkbox-group">
      <input type="checkbox" id="sunLightCheckbox" checked />
      <label for="sunLightCheckbox" style="margin: 0;">√âclairage solaire</label>
    </div>
    
    <div class="control-group checkbox-group">
      <input type="checkbox" id="shadowsCheckbox" />
      <label for="shadowsCheckbox" style="margin: 0;">Ombres</label>
    </div>

    <div class="control-group checkbox-group" style="margin-top: 12px;">
      <input type="checkbox" id="fl115Checkbox" />
      <label for="fl115Checkbox" class="fl115-label" style="margin: 0;">Grille FL115</label>
    </div>
    
    <div class="slider-container" style="margin-top: 10px;">
      <label>
        <span>Luminosit√© :</span>
        <span id="brightnessValue">1.0</span>
      </label>
      <input type="range" id="brightnessSlider" min="0" max="2" value="1" step="0.1" />
    </div>
    
    <div class="control-group" style="margin-top: 12px;">
      <input type="password" id="cesiumIonKeyInput" placeholder="Collez votre cl√© API Cesium Ion ici" style="display: none; width: 100%; padding: 6px; border-radius: 4px; border: 1px solid #666; background: #333; color: white; font-size: 12px; margin-bottom: 6px;" />
      <button id="loadCesiumKeyBtn" class="tooltip-btn" 
              style="width: 100%; padding: 6px; border-radius: 4px; border: 1px solid #666; background: #444; color: white; font-size: 12px; cursor: pointer; position: relative;"
              title="Entrez votre cl√© API Cesium Ion (gratuite sur cesium.com/ion) pour activer le terrain 3D r√©aliste (relief, altitudes)."
              aria-label="Charger une cl√© Cesium Ion pour le 3D">
        Charger une cl√© Cesium pour voir en 3D
      </button>
    </div>

    <div class="control-group" style="margin-top: 12px;">
      <button id="openCesiumBtn" 
              style="width: 100%; padding: 6px; border-radius: 4px; border: 1px solid #666; background: #2196F3; color: white; font-size: 12px; cursor: pointer; font-weight: bold;"
              title="Ouvrir Cesium dans un nouvel onglet"
              aria-label="Acc√©der √† Cesium">
        üåç Cesium plus d'infos
      </button>
    </div>
  </div>
  
  <!-- Spinner global -->
  <div id="globalSpinner" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999; justify-content: center; align-items: center; flex-direction: column; color: white; font-family: sans-serif;">
    <div style="font-size: 20px; margin-bottom: 20px;">‚è≥ Chargement en cours...</div>
    <div style="width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite;"></div>
    <div id="globalSpinnerText" style="margin-top: 20px; font-size: 14px;">Chargement de la trace</div>
  </div>
  
  <!-- Status -->
  <div id="status">‚è≥ Chargement...</div>
  
  <!-- Scripts -->
  <script src="TraceConverter.js"></script>
  <script src="./script.js"></script>
  <script src="dashboard.js"></script>
  
  <!-- Script inline pour dashboard (drag + croix + case ‚Äì simple et sans erreur) -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const dashboard = document.getElementById('dashboard');
      const dashboardCheckbox = document.getElementById('dashboardCheckbox');
      const closeDashboard = document.getElementById('closeDashboard');
      const dashboardHeader = document.getElementById('dashboardHeader');
      const dashboardContent = document.querySelector('.dashboard-content');

      if (!dashboard || !dashboardCheckbox || !closeDashboard || !dashboardHeader) return;

      // Afficher/masquer avec la case
      dashboardCheckbox.addEventListener('change', function() {
        if (this.checked) {
          dashboard.style.display = 'block';
          dashboard.style.left = '50%';
          dashboard.style.top = '150px';
          dashboard.style.transform = 'translateX(-50%)';
        } else {
          dashboard.style.display = 'none';
        }
      });

      // Croix ferme et d√©coche
      closeDashboard.addEventListener('click', function() {
        dashboard.style.display = 'none';
        dashboardCheckbox.checked = false;
      });

      // Drag & drop (main qui glisse vraiment)
      let isDragging = false;
      let startX, startY, initialLeft, initialTop;

      dashboardHeader.addEventListener('mousedown', function(e) {
        if (e.target === closeDashboard || e.target === document.getElementById('minimizeDashboard')) return;
        isDragging = true;
        startX = e.clientX;
        startY = e.clientY;
        initialLeft = dashboard.offsetLeft;
        initialTop = dashboard.offsetTop;
        dashboardHeader.style.cursor = 'grabbing';
        e.preventDefault();
      });

      document.addEventListener('mousemove', function(e) {
        if (!isDragging) return;
        const newLeft = initialLeft + (e.clientX - startX);
        const newTop = initialTop + (e.clientY - startY);
        dashboard.style.left = newLeft + 'px';
        dashboard.style.top = newTop + 'px';
        dashboard.style.transform = 'none';
      });

      document.addEventListener('mouseup', function() {
        isDragging = false;
        dashboardHeader.style.cursor = 'grab';
      });

      // Minimiser (optionnel)
      const minimizeBtn = document.getElementById('minimizeDashboard');
      if (minimizeBtn) {
        minimizeBtn.addEventListener('click', function() {
          if (dashboardContent.style.display === 'none') {
            dashboardContent.style.display = 'block';
            minimizeBtn.textContent = '‚Äì';
          } else {
            dashboardContent.style.display = 'none';
            minimizeBtn.textContent = '+';
          }
        });
      }
    });
  </script>
</body>
</html>
